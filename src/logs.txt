PS C:\Users\thoma\OneDrive\SONEAR 2025\site_v1_next> npm run dev

> site_v1_next@0.1.0 dev
> next dev --turbopack

   â–² Next.js 15.5.3 (Turbopack)
   - Local:        http://localhost:3000
   - Network:      http://10.13.94.184:3000
   - Environments: .env.local

 âœ“ Starting...
 âœ“ Ready in 3.7s
 â—‹ Compiling / ...
 âœ“ Compiled / in 12.6s
(node:8168) [DEP0040] DeprecationWarning: The `punycode` module is deprecated. Please use a userland alternative instead.
(Use `node --trace-deprecation ...` to show where the warning was created)
 GET / 200 in 15233ms
 â—‹ Compiling /products/[category] ...
 âœ“ Compiled /products/[category] in 2s
(node:4808) [DEP0040] DeprecationWarning: The `punycode` module is deprecated. Please use a userland alternative instead.
(Use `node --trace-deprecation ...` to show where the warning was created)
 GET /products/bas 200 in 4812ms
 â—‹ Compiling /api/admin/product-images/[imageId]/signed-url ...
 âœ“ Compiled /api/admin/product-images/[imageId]/signed-url in 1480ms
(node:18216) [DEP0040] DeprecationWarning: The `punycode` module is deprecated. Please use a userland alternative instead.
(Use `node --trace-deprecation ...` to show where the warning was created)
 GET /api/admin/product-images/3ffb49b5-8720-4539-871c-42c20e1c4919/signed-url?variant=md&format=avif&mode=json 200 in 4868ms       
 GET /api/admin/product-images/3ffb49b5-8720-4539-871c-42c20e1c4919/signed-url?variant=md&format=avif&mode=json 200 in 4925ms       
 GET /api/admin/product-images/edf1d67f-ff56-43d6-aeb1-46c60bee5405/signed-url?variant=md&format=avif&mode=json 200 in 4940ms       
 GET /api/admin/product-images/edf1d67f-ff56-43d6-aeb1-46c60bee5405/signed-url?variant=md&format=avif&mode=json 200 in 4936ms       
 â—‹ Compiling /manifest.json ...
 âœ“ Compiled /manifest.json in 795ms
 GET /manifest.json 200 in 1545ms
 â—‹ Compiling /product/[id] ...
 âœ“ Compiled /product/[id] in 1757ms
(node:16900) [DEP0040] DeprecationWarning: The `punycode` module is deprecated. Please use a userland alternative instead.
(Use `node --trace-deprecation ...` to show where the warning was created)
 GET /product/b2a4608d-b52c-4165-b88e-3307330569fd 200 in 3873ms
 GET /api/admin/product-images/edf1d67f-ff56-43d6-aeb1-46c60bee5405/signed-url?variant=xl&format=avif&mode=json 200 in 2291ms       
 GET /api/admin/product-images/a7511909-0247-479a-bf0e-1ee67ac9ffc2/signed-url?variant=xl&format=avif&mode=json 200 in 2410ms       
 GET /api/admin/product-images/1caed607-10ca-43b3-8c07-654c6e9ff9a1/signed-url?variant=xl&format=avif&mode=json 200 in 2360ms       
 GET /api/admin/product-images/a7511909-0247-479a-bf0e-1ee67ac9ffc2/signed-url?variant=xl&format=avif&mode=json 200 in 2486ms       
 GET /api/admin/product-images/1caed607-10ca-43b3-8c07-654c6e9ff9a1/signed-url?variant=xl&format=avif&mode=json 200 in 2500ms       
 GET /api/admin/product-images/edf1d67f-ff56-43d6-aeb1-46c60bee5405/signed-url?variant=xl&format=avif&mode=json 200 in 2511ms       
 GET /manifest.json 200 in 889ms
(node:16624) [DEP0040] DeprecationWarning: The `punycode` module is deprecated. Please use a userland alternative instead.
(Use `node --trace-deprecation ...` to show where the warning was created)
 â—‹ Compiling /checkout-test ...
 âœ“ Compiled /checkout-test in 1481ms
 GET /checkout-test 200 in 2325ms
 â—‹ Compiling /api/checkout/create-session ...
 âœ“ Compiled /api/checkout/create-session in 1497ms



â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸš€ CHECKOUT SESSION CREATION START
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•       

ğŸ“¦ Step 1: Request received
   â””â”€ Items count: 1
   â””â”€ Customer email: thomas.renaudin@sonear.com

ğŸ” Step 2: Validation
   âœ… Cart has items
   âœ… Address is complete

ğŸ’° Step 3: Amount calculation
   â””â”€ Total: 165.00 â‚¬

ğŸ“ Step 4: Creating order in Supabase
   â”Œâ”€ Shipping address to insert:
   â”‚  Type: object
   â”‚  Value: {
  "first_name": "Thomas",
  "last_name": "Renaudin",
  "email": "thomas.renaudin@sonear.com",
  "phone": "+33611854966",
  "address_line1": "sonear",
  "address_line2": "25 bd latour maubourg 2",
  "city": "PARIS 7",
  "postal_code": "75007",
  "country": "FR"
}
   â””â”€ [Preparing INSERT...]
   â”Œâ”€ Insert data prepared
   â””â”€ Keys: order_number, customer_email, customer_name, customer_phone, shipping_address, billing_address, total_amount, shipping_amount, tax_amount, discount_amount, shipping_method, status, payment_status, fulfillment_status, notes, admin_notes, stripe_session_id, payment_intent_id, user_id

   âœ… Order created (returned from INSERT):
   â”œâ”€ ID: 969a4941-11ac-458d-9494-454c38e6e818
   â”œâ”€ Number: ORD-20251017-013
   â”œâ”€ Email: thomas.renaudin@sonear.com
   â”œâ”€ Total: 165
   â”œâ”€ shipping_address type: object
   â”œâ”€ shipping_address is null? false
   â””â”€ shipping_address value: {
  "city": "PARIS 7",
  "email": "thomas.renaudin@sonear.com",
  "phone": "+33611854966",
  "country": "FR",
  "last_name": "Renaudin",
  "first_name": "Thomas",
  "postal_code": "75007",
  "address_line1": "sonear",
  "address_line2": "25 bd latour maubourg 2"
}

ğŸ” Step 5: IMMEDIATE RE-READ from database
   â””â”€ [Executing SELECT immediately after INSERT...]
   âœ… Verification SELECT successful:
   â”œâ”€ Order number: ORD-20251017-013
   â”œâ”€ Created at: 2025-10-17T12:00:59.354587+00:00
   â”œâ”€ Updated at: 2025-10-17T12:00:59.354587+00:00
   â”œâ”€ shipping_address type: object
   â”œâ”€ shipping_address is null? false
   â””â”€ shipping_address value: {
  "city": "PARIS 7",
  "email": "thomas.renaudin@sonear.com",
  "phone": "+33611854966",
  "country": "FR",
  "last_name": "Renaudin",
  "first_name": "Thomas",
  "postal_code": "75007",
  "address_line1": "sonear",
  "address_line2": "25 bd latour maubourg 2"
}
   âœ… shipping_address is preserved immediately after INSERT      

ğŸ’³ Step 6: Creating Stripe session
   âœ… Session created: cs_test_a1OIIpFoSnhGedwoLPLj6kv13Va6aaPOlXRkdrFWKC0Eep03T4X11rA91M

ğŸ”— Step 7: Linking session to order
   âœ… Session linked

ğŸ” Step 8: FINAL VERIFICATION before redirect
   â”œâ”€ stripe_session_id: cs_test_a1OIIpFoSnhGedwoLPLj6kv13Va6aaPOlXRkdrFWKC0Eep03T4X11rA91M
   â”œâ”€ shipping_address is null? false
   â””â”€ shipping_address: {
  "city": "PARIS 7",
  "email": "thomas.renaudin@sonear.com",
  "phone": "+33611854966",
  "country": "FR",
  "last_name": "Renaudin",
  "first_name": "Thomas",
  "postal_code": "75007",
  "address_line1": "sonear",
  "address_line2": "25 bd latour maubourg 2"
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•       
âœ… SUCCESS - Redirecting to Stripe
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•       


 POST /api/checkout/create-session 200 in 3974ms
 â—‹ Compiling /api/webhooks/stripe ...
 âœ“ Compiled /api/webhooks/stripe in 2.6s
ğŸ” RESEND_API_KEY prÃ©sente: true
ğŸ” RESEND_API_KEY (premiers caractÃ¨res): re_WuWQyW3
ğŸ“§ ExpÃ©diteur configurÃ©: Blanche Renaudin <contact@blancherenaudin.com>

ğŸ”” Webhook: payment_intent.succeeded

ğŸ”” Webhook: checkout.session.completed

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•       
ğŸ‰ CHECKOUT SESSION COMPLETED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•       
Session ID: cs_test_a1OIIpFoSnhGedwoLPLj6kv13Va6aaPOlXRkdrFWKC0Eep03T4X11rA91M

ğŸ“‹ Step 1: Fetching full session from Stripe...

ğŸ”” Webhook: payment_intent.created
â„¹ï¸ Unhandled: payment_intent.created

ğŸ”” Webhook: charge.succeeded
â„¹ï¸ Unhandled: charge.succeeded
 POST /api/webhooks/stripe 200 in 4096ms
 POST /api/webhooks/stripe 200 in 4313ms

ğŸ”” Webhook: charge.updated
â„¹ï¸ Unhandled: charge.updated
 POST /api/webhooks/stripe 200 in 2054ms
   âœ… Full session retrieved
   âœ… Payment Intent ID: pi_3SJCLJB4PqZwqkUz02KxrN86

ğŸ“‹ Step 2: Reading order from Supabase...
   â””â”€ Looking for stripe_session_id: cs_test_a1OIIpFoSnhGedwoLPLj6kv13Va6aaPOlXRkdrFWKC0Eep03T4X11rA91M

   âœ… Order found in database:
   â”œâ”€ Order ID: 969a4941-11ac-458d-9494-454c38e6e818
   â”œâ”€ Order number: ORD-20251017-013
   â”œâ”€ Created at: 2025-10-17T12:00:59.354587+00:00
   â”œâ”€ Updated at: 2025-10-17T12:01:13.719479+00:00
   â”œâ”€ shipping_address type: object
   â”œâ”€ shipping_address is null? true
   â”œâ”€ shipping_address value:
null
   â”œâ”€ billing_address type: object
   â”œâ”€ billing_address is null? false
   â””â”€ billing_address value:
{
      "city": "PARIS 7",
      "email": "thomas.renaudin@sonear.com",
      "phone": "+33611854966",
      "country": "FR",
      "last_name": "Renaudin",
      "first_name": "Thomas",
      "postal_code": "75007",
      "address_line1": "sonear",
      "address_line2": "25 bd latour maubourg 2"
}

   ğŸš¨ ğŸš¨ ğŸš¨ CRITICAL ALERT ğŸš¨ ğŸš¨ ğŸš¨
   ğŸš¨ shipping_address is NULL when webhook reads it!
   ğŸš¨ It was set to NULL BEFORE this webhook executed
   ğŸš¨ Check: triggers, RLS policies, or other code
   ğŸš¨ ğŸš¨ ğŸš¨ ğŸš¨ ğŸš¨ ğŸš¨ ğŸš¨ ğŸš¨ ğŸš¨ ğŸš¨ ğŸš¨ ğŸš¨


ğŸ“‹ Step 3: Checking for existing order items...
   âš ï¸ Order items already exist
   â””â”€ Will update payment status ONLY (no address modification)

ğŸ“‹ Step 4: Updating payment status...
   â””â”€ [Executing UPDATE with ONLY payment fields...]
   âœ… UPDATE successful
   â”œâ”€ shipping_address after UPDATE: null
   â””â”€ billing_address after UPDATE: {
  "city": "PARIS 7",
  "email": "thomas.renaudin@sonear.com",
  "phone": "+33611854966",
  "country": "FR",
  "last_name": "Renaudin",
  "first_name": "Thomas",
  "postal_code": "75007",
  "address_line1": "sonear",
  "address_line2": "25 bd latour maubourg 2"
}

   ğŸš¨ shipping_address is STILL NULL after UPDATE
   ğŸš¨ But we did NOT modify it in the UPDATE!
   ğŸš¨ This confirms: it was ALREADY NULL before UPDATE

ğŸ“¦ Starting stock decrement for order: 969a4941-11ac-458d-9494-454c38e6e818
 POST /api/webhooks/stripe 200 in 5213ms
ğŸ“‹ Found 1 items to process
ğŸ“¦ Product b2a4608d-b52c-4165-b88e-3307330569fd: 28 â†’ 27 (Î” -1)
âœ… Stock decremented for: .white glade skirt - S (qty: 1)
ğŸ“Š Stock decrement summary: 1/1 items processed
ğŸ“§ Fetching order details for ID: 969a4941-11ac-458d-9494-454c38e6e818
âœ… Order found: ORD-20251017-013
============================================================
ğŸ“¦ DEBUG SHIPPING ADDRESS
============================================================      
ğŸ“¦ Raw shipping_address from DB: null
ğŸ“¦ Type of shipping_address: object
ğŸ“¦ Is null? true
ğŸ“¦ Is undefined? false
ğŸ“¦ Has address_line1? null
============================================================
âœ… Found 1 items
ğŸ” PARSING SHIPPING ADDRESS
ğŸ” shippingAddress?.address_line_1: undefined
ğŸ” shippingAddress?.city: undefined
ğŸ” shippingAddress?.postal_code: undefined
ğŸ” shippingAddress?.country: undefined
âœ… Formatted address for email: {
  "line1": "",
  "city": "",
  "postalCode": "",
  "country": ""
}
ğŸ“¤ Envoi email: {
  from: 'Blanche Renaudin <contact@blancherenaudin.com>',
  to: [ 'thomas.renaudin@sonear.com' ],
  subject: 'Confirmation de commande #ORD-20251017-013',
  type: 'order-confirmation'
}
 â—‹ Compiling /checkout/success ...
âœ… Email envoyÃ© avec succÃ¨s: {
  id: '7262d8b0-2ac3-416f-bc4e-000e3cad232d',
  from: 'Blanche Renaudin <contact@blancherenaudin.com>',
  to: 'thomas.renaudin@sonear.com',
  type: 'order-confirmation'
}
âœ… Email de confirmation envoyÃ© pour la commande ORD-20251017-013
âœ… Email sent
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•       
âœ… WEBHOOK COMPLETED (items already existed)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•       

 POST /api/webhooks/stripe 200 in 6465ms
 âœ“ Compiled /checkout/success in 1716ms
 GET /checkout/success?session_id=cs_test_a1OIIpFoSnhGedwoLPLj6kv13Va6aaPOlXRkdrFWKC0Eep03T4X11rA91M 200 in 2545ms
 â—‹ Compiling /api/orders/by-session/[sessionId] ...
 âœ“ Compiled /api/orders/by-session/[sessionId] in 860ms
(node:18676) [DEP0040] DeprecationWarning: The `punycode` module is deprecated. Please use a userland alternative instead.
(Use `node --trace-deprecation ...` to show where the warning was created)
 GET /api/orders/by-session/cs_test_a1OIIpFoSnhGedwoLPLj6kv13Va6aaPOlXRkdrFWKC0Eep03T4X11rA91M 200 in 3647ms
